<!DOCTYPE html>
<html lang="en">

<!DOCTYPE html>

<!--from http://shancarter.github.io/ucb-dataviz-fall-2013/classes/interactive-maps/slider-map.html-->
<head>

    <style>
        body {
            font-family: Helvetica;
        }

        #title {
            margin-left: 50px;
        }

        svg {
            border: solid 1px #ddd;
            margin-left: 50px;
            /*margin-top: 5px;*/
        }

        .month {
            margin-left: 50px;
        }

        .county {
            fill: grey;
            stroke: white;
        }

        .tooltip {
            position: absolute;
            background: white;
            border: 2px solid black;
            left: 100px;
            padding: 5px;
            border-radius: 5px;
        }

        input {
            display: block;
            width: 200px;
            margin-left: 50px;
            /*margin-bottom: 10px;*/
        }

        a {
            margin-left: 50px;
        }

        .description{
            margin-left: 50px;
        }

    </style>

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>

</head>

<body>

<h1 id="title">Retail and recreation: How did the number of visitors change since the pandemic?</h1>
<div class="description">
    <p>
        Using Python to read the csv file. Split the date attribute into month and year, groupby the data using country name, month and year attributes, then calculate the average values.
        Data source links are shown below the map.
    </p>
</div>
<h4 class="month"></h4>
<div class="slider"></div>

<script>

    var margin = {top: 20, right: 50, bottom: 20, left: 10};
    width = 900 - margin.left - margin.right,
        height = 700 - margin.top - margin.bottom;

    var curr_m, curr_y;

    var month_list = ["February 2020","March 2020","April 2020","May 2020","June 2020","July 2020","August 2020","September 2020","October 2020","November 2020","December 2020","January 2021","February 2021","March 2021"];

    var color_domain = [-80,-70,-60,-50,-40,-30,-20,-10,0,5,10,15,20,25,30,35,40];

    var legend_labels = ["<=-80%","-70%","-60","-50%","-40%","-30%","-20%","-10%","0%","5%","10%","15%","20%","25%","30%","35%",">=40%"];

    var color = d3.scale.threshold()
        .domain(color_domain)

        .range([
            "#2F0000","#4D0000","#750000","#AE0000","#EA0000",
            "#FF0000","#FF5151","#FF7575","#FF9797",
            "#ECF5FF",
            "#C4E1FF","#97CBFF","#84C1FF","#66B3FF","#46A3FF","#2894FF","#0080FF","#0072E3"

        ]);

    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    queue()
        .defer(d3.csv, "retail_and_creation.csv")
        .defer(d3.json, "world.json")
        .await(ready);

    function ready(error, data, ca) {

        var counties = ca;

        // convert data into numbers
        data.forEach(function(d) {
            d.month = +d.month;
            d.retail_and_recreation_percent_change_from_baseline = +d.retail_and_recreation_percent_change_from_baseline;
        });

        // d3.nest the data by country name then by month
        var dataByCountyByYear = d3.nest()
            .key(function(d) { return d.name; })
            .key(function(d) {return d.year; })
            .key(function(d) { return d.month; })
            .map(data);

        // merge geo data with covid data
        counties.features.forEach(function(county) {
            county.properties.year = dataByCountyByYear['$'+county.properties.name];
        });


        var projection = d3.geoNaturalEarth()
            .scale(width / 2 / Math.PI)
            .translate([width / 2, height / 2])
        var path = d3.geoPath()
            .projection(projection);

        var Tooltip = d3.select("body")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltip")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "2px")
            .style("border-radius", "5px")
            .style("padding", "5px")

        var mouseover = function(d) {
            Tooltip
                .style("opacity", 1)
                .style("left",(d3.event.pageX)+"px")
                .style("top",(d3.event.pageY+20)+"px")

            d3.select(this)
                .style("stroke","black")
        }

        var mousemove = function(d) {
            //in case there are some countries not listed in the dataset
            var num;
            try{
                num = d.properties.year['$'+curr_y]['$'+curr_m][0]['retail_and_recreation_percent_change_from_baseline'];
                Tooltip
                    .html(d.properties.name+":"+num+"%")
                    .style("left", (d3.mouse(this)[0]+90) + "px") // It is important to put the +90: other wise the tooltip is exactly where the point is an it creates a weird effect
                    .style("top", (d3.mouse(this)[1]) + "px")
            }
            catch(e){
                num = 'Unknown';
                Tooltip
                    .html(d.properties.name+":"+num)
                    .style("left", (d3.mouse(this)[0]+90) + "px") // It is important to put the +90: other wise the tooltip is exactly where the point is an it creates a weird effect
                    .style("top", (d3.mouse(this)[1]) + "px")
            }
        }

        var mouseleave = function(d) {
            Tooltip
                .style("opacity", 0)
            d3.select(this)
                .style("stroke","white")
        }

        var countyShapes = svg.selectAll(".county")
            .data(counties.features)
            .enter().append("path")
            .attr("class", "county")
            .attr("d", path)
            .on("mouseover", mouseover)
            .on("mousemove",mousemove)
            .on("mouseleave", mouseleave);

        function update(t){
            slider.property("value", t);
            d3.select(".month").text(month_list[t-1]);
            countyShapes.style("fill", function(d) {
                //in case for some countries, there is no data available for specific month
                var c, y, m;
                if(t < 12){
                    y = 2020;
                    m = Number(t) + 1;
                }
                else{
                    y = 2021;
                    m = Number(t) - 11;
                }
                curr_m = m;
                curr_y = y;
                try{
                    c = Math.round(d.properties.year['$'+y]['$'+m][0]['retail_and_recreation_percent_change_from_baseline']);
                    return color(c)
                }
                catch(e){
                        return "gray"
                    }
            });
        }

        var slider = d3.select(".slider").append("input")
            .attr("type", "range")
            .attr("min", 1)
            .attr("max", 14)
            .attr("step", 1)
            .on("change", function() {
                var time = this.value;
                update(time);
            });

        update(1);
    }

    var legend = svg.selectAll("g.legend")
        .data(color_domain)
        .enter().append("g")
        .attr("class", "legend");

    var ls_w = 20, ls_h = 17;

    legend.append("rect")
        .attr("x", 20)
        .attr("y", function(d, i){ return (i*ls_h) + 2*ls_h - 50;})
        .attr("width", ls_w)
        .attr("height", ls_h)
        .style("fill", function(d, i) { return color(d); })
        .style("opacity", 0.8);

    legend.append("text")
        .attr("x", 50)
        .attr("y", function(d, i){ return (i*ls_h) + ls_h - 20;})
        .text(function(d, i){ return legend_labels[i]; });

</script>
<h6 class="description">
    Data source:
    <a href="https://www.google.com/covid19/mobility/" style="font-size: inherit">Google's global covid-19 community mobility report dataset</a>
    <a href="https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson" style="font-size: inherit">World map dataset</a>
</h6>
</body>
</html>